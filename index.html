<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baleine sous gravillon â€“ Player</title>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0b0e14">

<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#f3c300}
body{
font-family:Segoe UI,Roboto,Arial,sans-serif;
color:#eaeaea;
background:#0b0e14;
min-height:100vh;
padding-bottom:160px
}
header{text-align:center;padding:32px;background:rgba(0,0,0,.7)}
.logo-main{max-width:200px}
.container{max-width:820px;margin:auto;padding:24px}
.grid-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px}
.season-item,.episode-item{
padding:15px;border-radius:12px;
background:rgba(255,255,255,.05);
cursor:pointer;transition:.3s
}
.season-item:hover{background:var(--primary);color:#111}
.episode-item{display:flex;align-items:center;justify-content:space-between}
.episode-item:hover{background:rgba(255,255,255,.1)}
.episode-item.current{border-left:5px solid var(--primary)}
.episode-title{flex-grow:1}
.btn-share{
border:1px solid var(--primary);
background:none;color:var(--primary);
width:34px;height:34px;border-radius:50%;
cursor:pointer
}
.player-container{
position:fixed;bottom:0;left:0;right:0;
background:rgba(0,0,0,.95);
padding:18px;border-top:1px solid rgba(243,195,0,.3)
}
.now-playing{text-align:center;color:var(--primary);margin-bottom:10px}
audio{width:100%}
#toast{
position:fixed;bottom:120px;left:50%;
transform:translateX(-50%);
background:var(--primary);color:#111;
padding:10px 20px;border-radius:20px;
opacity:0;transition:.3s;font-weight:bold
}
#toast.show{opacity:1}
.loader{text-align:center;color:var(--primary);padding:20px}
</style>
</head>

<body>

<header>
<img src="https://baleinesousgravillon.com/wp-content/uploads/2023/08/logo-accueil3Plan-de-travail-2-copie-3@2x-1.png" class="logo-main">
</header>

<div class="container">
<div id="seasons_grid" class="grid-list"></div>
<div id="episodes_list"></div>
</div>

<div class="player-container">
<div id="now-playing-title" class="now-playing">SÃ©lectionnez une aventureâ€¦</div>
<audio id="player" controls playsinline></audio>
</div>

<div id="toast">Lien copiÃ© !</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwm-8iBh2aMDepvxSHpl0ywwlZpWIaEEh7veSNYyEG-X0gSalh6--vbhxyV4PR2GXMjvQ/exec";
let allPlaylists=[], episodes=[], current=0;

async function callApi(params){
const r=await fetch(`${SCRIPT_URL}?${params}`);
return r.json();
}

/* ----------- PLAYLISTS ----------- */
async function loadPlaylists(){
const urlParams=new URLSearchParams(location.search);
const sharedId=urlParams.get("playlistId");

allPlaylists=(await callApi("action=getPlaylists")).filter(p=>p.public);
const seasons=[...new Set(allPlaylists.map(p=>p.season))].sort().reverse();
const grid=document.getElementById("seasons_grid");

grid.innerHTML=seasons.map(s=>`
<div class="season-item" data-season="${encodeURIComponent(s)}">${s}</div>
`).join("");

grid.querySelectorAll(".season-item").forEach(el=>{
el.addEventListener("click",()=>{
showPlaylistsBySeason(decodeURIComponent(el.dataset.season));
});
});

if(sharedId){
const decoded=decodeURIComponent(sharedId);
const p=allPlaylists.find(x=>String(x.id).trim()===decoded.trim());
if(p){
showPlaylistsBySeason(p.season);
loadEpisodes(encodeURIComponent(p.id));
return;
}
}
showPlaylistsBySeason(seasons[0]);
}

function showPlaylistsBySeason(season){
const div=document.getElementById("episodes_list");
const list=allPlaylists.filter(p=>p.season===season);

div.innerHTML=`<h3>Playlists â€” ${season}</h3>`+list.map(p=>`
<div class="episode-item" data-pid="${encodeURIComponent(p.id)}">
<span class="episode-title"><strong>${p.name}</strong></span>
<button class="btn-share">ðŸ”—</button>
</div>
`).join("");

div.querySelectorAll(".episode-item").forEach(item=>{
const pid=item.dataset.pid;
item.querySelector(".episode-title").addEventListener("click",()=>loadEpisodes(pid));
item.querySelector(".btn-share").addEventListener("click",e=>sharePlaylist(e,pid));
});
}

/* ----------- SHARE ----------- */
function sharePlaylist(e,encodedPid){
e.stopPropagation();
const url=new URL(location.origin+location.pathname);
url.searchParams.set("playlistId",encodedPid);
navigator.clipboard.writeText(url.toString()).then(showToast);
}

function showToast(){
const t=document.getElementById("toast");
t.classList.add("show");
setTimeout(()=>t.classList.remove("show"),2500);
}

/* ----------- EPISODES ----------- */
async function loadEpisodes(encodedPid){
const pid=decodeURIComponent(encodedPid);
const div=document.getElementById("episodes_list");
div.innerHTML='<div class="loader">PlongÃ©eâ€¦</div>';

episodes=await callApi(`action=getEpisodes&playlistId=${encodeURIComponent(pid)}`);
if(!episodes.length){div.innerHTML="<p>Aucun Ã©pisode.</p>";return;}

div.innerHTML="<h3>Ã‰pisodes</h3>"+episodes.map((e,i)=>`
<div class="episode-item list-item-ep" data-i="${i}">
<span class="episode-title">${e.title}</span>
</div>
`).join("");

div.querySelectorAll(".list-item-ep").forEach(el=>{
el.addEventListener("click",()=>play(+el.dataset.i));
});

play(0);
}

/* ----------- PLAYER ----------- */
async function play(i){
current=i;
const audio=document.getElementById("player");
document.querySelectorAll(".list-item-ep").forEach(e=>e.classList.remove("current"));
document.querySelector(`.list-item-ep[data-i="${i}"]`)?.classList.add("current");

document.getElementById("now-playing-title").innerText=episodes[i].title;
const url=await callApi(`action=getAudio&guid=${episodes[i].guid}`);
audio.src=url;
audio.play();
}

audio.onended=()=>{if(current+1<episodes.length)play(current+1)}

loadPlaylists();
</script>

</body>
</html>
